"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[69],{1228:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>m,frontMatter:()=>s,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"Examples","title":"Examples","description":"Don\'t use SELECT *","source":"@site/docs/2- Examples.md","sourceDirName":".","slug":"/Examples","permalink":"/doc-devlens/Examples","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Usage Command","permalink":"/doc-devlens/Usage command"},"next":{"title":"Abstract Syntax Tree","permalink":"/doc-devlens/How it works/Abstract Syntax Tree"}}');var a=t(4848),o=t(8453);const s={},i="Examples",l={},c=[{value:"Don&#39;t use SELECT *",id:"dont-use-select-",level:2},{value:"Don&#39;t use different DB environments in the same file",id:"dont-use-different-db-environments-in-the-same-file",level:2},{value:"Use right dependencies",id:"use-right-dependencies",level:2},{value:"Retrieve your Environment variable directly from your Kubernetes secrets",id:"retrieve-your-environment-variable-directly-from-your-kubernetes-secrets",level:2},{value:"Replace &#39;HDFS&#39; to &#39;S3&#39;",id:"replace-hdfs-to-s3",level:2}];function d(e){const n={a:"a",br:"br",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",img:"img",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"examples",children:"Examples"})}),"\n",(0,a.jsx)(n.h2,{id:"dont-use-select-",children:"Don't use SELECT *"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"#example.sql\ninsert into DEV_DB_AAAA.SC_PARAM_AAAA.TABLE_AAAA \n(SELECT * FROM REC_DB_BBBB.SC_PARAM_AAAA.TABLE_AAAA)\n"})}),"\n",(0,a.jsxs)(n.p,{children:["To be sure there isn't any ",(0,a.jsx)(n.code,{children:"SELECT *"})," in your whole project, an annotator can find every occurrence of Wildcard in your code:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'from annotators.common.abstract_annotator import AbstractAnnotator\nfrom annotators.common.search import findAll\nfrom annotators.common.annotation import Annotation\n\nfrom antlr4 import ParserRuleContext\n\n\nclass SparkSQLSelectWildcard(AbstractAnnotator):\n    def parse(self, ast: ParserRuleContext):\n        selectClause = findAll(ast, "SelectClause")\n        namedExpressionSeq = findAll(selectClause, "NamedExpressionSeq")\n        star = findAll(namedExpressionSeq, "Star")\n\n        for match in star:\n            yield Annotation(\n                name="Select_Wildcard",\n                context=match,\n            )\n'})}),"\n",(0,a.jsxs)(n.p,{children:["You can then query your database to check if this annotator found any ",(0,a.jsx)(n.code,{children:"SELECT *"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:'SELECT path \nFROM annotation \nWHERE name= "Select_Wildcard"\n'})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.br,{}),"\n",(0,a.jsx)(n.img,{alt:"select-wildcard-query",src:t(4045).A+"",title:"select-wildcard-query",width:"1401",height:"472"})]}),"\n",(0,a.jsx)(n.h2,{id:"dont-use-different-db-environments-in-the-same-file",children:"Don't use different DB environments in the same file"}),"\n",(0,a.jsx)(n.p,{children:"Be sure the same environment is used in each file. You can create an annotator that will get every DB environment of your project:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'#example.py\nfrom annotators.common.abstract_annotator import AbstractAnnotator\nfrom annotators.common.search import findAll\nfrom annotators.common.annotation import Annotation\n\nfrom antlr4 import ParserRuleContext\n\nENV_LIST = ["DEV", "INT", "REC", "PRD"]\n\n\nclass SparkSQLTableEnv(AbstractAnnotator):\n    def parse(self, ast: ParserRuleContext):\n        fromClause = findAll(ast, "FromClause")\n        tableNames = findAll(fromClause, "TableName")\n        multipartIdentifier1 = findAll(tableNames, "MultipartIdentifier")\n\n        insertInto = findAll(ast, "InsertIntoTable")\n        multipartIdentifier2 = findAll(insertInto, "MultipartIdentifier")\n\n        all_names = multipartIdentifier1 + multipartIdentifier2\n\n        for match in all_names:\n            starting_str = self.getText(match).split("_")[0].upper()\n            if starting_str in ENV_LIST:\n                yield Annotation(name="Table_Env", value=starting_str, context=match)\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Then you can query the ",(0,a.jsx)(n.strong,{children:"Devlens"})," DB:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"SELECT path \nFROM annotation \nWHERE name = 'Table_Env' \nAND name IN (\n    SELECT name \n    FROM annotation \n    WHERE name = 'Table_Env' \n    GROUP BY name \n    HAVING COUNT(DISTINCT value) > 1)\nORDER BY path;\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.em,{children:"This query will display every file where there is more than one environment used."})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.br,{}),"\n",(0,a.jsx)(n.img,{alt:"env-diff-query",src:t(7237).A+"",title:"env-diff-query",width:"1477",height:"482"})]}),"\n",(0,a.jsx)(n.h2,{id:"use-right-dependencies",children:"Use right dependencies"}),"\n",(0,a.jsx)(n.p,{children:"It's hard to list every dependency used in a project:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'#example.py\nimport dataiku\n\nfrom pyspark import SparkContext\nfrom pyspark.sql import SQLContext\n\nfrom snowflake.snowpark import Session\nfrom snowflake.snowpark.functions import *\nfrom snowflake.snowpark.exceptions import SnowparkSQLException\nimport snowflake_package\nfrom snowflake.snowpark.types import *\n\nsc = SparkContext.getOrCreate()\nsqlContext = SQLContext(sc)\n\nUSER = str(Path.home()).split("/")[-1]\ntry:\n    connection = snowflake_package.get_connection(\n        key_path=f"{Path.home()}/.secure/{USER}_snowflake.pem", warehouse="WH_TEST")\nexcept:\n    connection = snowflake_package.get_connection(\n        key_path=f"{Path.home()}/.secure/snowflake.p8", warehouse="WH_TEST")\n'})}),"\n",(0,a.jsx)(n.p,{children:"An annotator can retrieve every dependency importation in a project:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'from annotators.common.abstract_annotator import AbstractAnnotator\nfrom annotators.common.search import findAll\nfrom annotators.common.annotation import Annotation\n\nfrom antlr4 import ParserRuleContext\n\n\nclass PythonFromImportAnnotator(AbstractAnnotator):\n    def parse(self, ast: ParserRuleContext):\n        importStmts = findAll(ast, "Import_stmt")\n        importFroms = findAll(importStmts, "Import_from")\n\n        for importFrom in importFroms:\n            names = findAll(importFrom, "Dotted_name")\n            importFromAsNames = findAll(importFrom, "Import_from_as_name")\n\n            module = names[0].getText()\n            for submodule in importFromAsNames:\n                yield Annotation(\n                    name="From_Import",\n                    value=module + "." + submodule.getText(),\n                    context=submodule,\n                )\n'})}),"\n",(0,a.jsxs)(n.p,{children:["You can then query the ",(0,a.jsx)(n.strong,{children:"Devlens"})," DB:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:'SELECT value \nFROM annotation \nWHERE name = "From_Import";\n'})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.br,{}),"\n",(0,a.jsx)(n.img,{alt:"from-import-query",src:t(3962).A+"",title:"from-import-query",width:"963",height:"535"})]}),"\n",(0,a.jsx)(n.h2,{id:"retrieve-your-environment-variable-directly-from-your-kubernetes-secrets",children:"Retrieve your Environment variable directly from your Kubernetes secrets"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Devlens"})," is able to retrieve your environment variable automatically just by giving your config file path:"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsxs)(n.em,{children:["You will need a ",(0,a.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/",children:"kubeconfig file"})," and a helm ",(0,a.jsx)(n.a,{href:"https://helm.sh/docs/chart_template_guide/values_files/",children:"deployment file"})]}),"."]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"kube-analyze",src:t(845).A+"",title:"kube-analyze",width:"1477",height:"535"})}),"\n",(0,a.jsx)(n.p,{children:"An annotator finding every os.getenv will help you display your Kubernetes secrets:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'from annotators.common.abstract_annotator import AbstractAnnotator\nfrom annotators.common.search import findAll\nfrom annotators.common.annotation import Annotation\n\nfrom antlr4 import ParserRuleContext\n\n\nclass PythonGetenvAnnotator(AbstractAnnotator):\n    def parse(self, ast: ParserRuleContext):\n\n        getenv_calls = findAll(ast, "Primary", filters={"primary": "os.getenv"})\n        arguments = findAll(getenv_calls, "Arguments")\n        strings = findAll(arguments, "Strings")\n\n        for match in strings:\n            yield Annotation(name="os_getenv", value=self.getText(match), context=match)\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Then you can query the ",(0,a.jsx)(n.strong,{children:"Devlens"})," DB:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"SELECT path, value \nFROM annotation \nWHERE name='os.getenv';\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"kube-query",src:t(2445).A+"",title:"kube-query",width:"1477",height:"397"})}),"\n",(0,a.jsx)(n.p,{children:"For example, when you are doing a full upgrade of your application and need to be sure you swapped every old version of a function;"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Devlens"})," can analyze your whole project and tell you exactly in which file and which lines are your old code."]}),"\n",(0,a.jsxs)(n.p,{children:["You found something you want to change globally in your project? Use the ",(0,a.jsx)(n.strong,{children:"Replace"})," to modify your whole project with values you want."]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Devlens"})," can be integrated seamlessly into your development process since it also works directly in your ",(0,a.jsx)(n.strong,{children:"CI"}),"!"]}),"\n",(0,a.jsx)(n.p,{children:"It also integrates a Dataiku connection to retrieve easily your project from any Dataiku instance!"}),"\n",(0,a.jsx)(n.h2,{id:"replace-hdfs-to-s3",children:"Replace 'HDFS' to 'S3'"}),"\n",(0,a.jsx)(n.p,{children:"To migrate from HDFS to S3 in your project by changing every occurrence of 'hdfs://' to 's3a://':"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'#example.py\nfrom pyspark.sql import SparkSession\nfrom pyspark.sql import functions as F\n\nspark = SparkSession.builder.getOrCreate()\n\nexpected_df = (\n    spark.read.parquet("hdfs://HDFS_SERVER:3543/finance/pib/expected/")\n    .withColumn("year", F.year("date"))\n    .withColumnRenamed("pib", "expected_pib")\n)\nactual_df = (\n    spark.read.csv("hdfs://HDFS_SERVER:3543/finance/pib/actual/")\n    .withColumn("year", F.year("date"))\n)\n///....\n\nspark.stop()\n'})}),"\n",(0,a.jsx)(n.p,{children:"An annotator can find every spark.read you have:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'from annotators.common.abstract_annotator import AbstractAnnotator\nfrom annotators.common.annotation import Annotation\nfrom annotators.common.search import findAll\n\nfrom antlr4 import ParserRuleContext\n\n\nclass SparkReadParquetAnnotator(AbstractAnnotator):\n\n    def parse(self, ast: ParserRuleContext):\n        spark_read = findAll(\n            ast, "Primary", filters={"primary": "spark.read.parquet"}\n        )\n        spark_read += findAll(\n            ast, "Primary", filters={"primary": "spark.read.csv"}\n        )\n        arguments = findAll(spark_read, "Arguments")\n        strings = findAll(arguments, "Strings")\n\n        for expr in strings:\n            yield Annotation(\n                name="spark_read", value=self.getText(expr), context=expr\n            )\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Then with the ",(0,a.jsx)(n.strong,{children:"Devlens"})," replace command, you can change every occurrence directly in your terminal:"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"replace",src:t(1417).A+"",title:"replace",width:"1377",height:"788"})}),"\n",(0,a.jsx)(n.p,{children:"Then you can check on your code:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'#example.py\nfrom pyspark.sql import SparkSession\nfrom pyspark.sql import functions as F\n\nspark = SparkSession.builder.getOrCreate()\n\nexpected_df = (\n    spark.read.parquet("s3a://finance/pib/expected/")\n    .withColumn("year", F.year("date"))\n    .withColumnRenamed("pib", "expected_pib")\n)\nactual_df = (\n    spark.read.parquet("s3a://finance/pib/actual/")\n    .withColumn("year", F.year("date"))\n)\n'})})]})}function m(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},7237:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/env-diff-query-54b7a2f7a7a608f2b2387ebe0bae8111.png"},3962:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/from-import-query-be4e3f12199b5943aa60786107c19dd2.png"},845:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/kube-analyze-91b7fd6067c33528453090ca9ce082d7.png"},2445:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/kube-query-3a7bb203a5755a2bd33f517a8e39a08b.png"},1417:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/replace-8a2903f94643282b0d336fe5060190fc.png"},4045:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/select-wildcard-query-fbad98e5cd3e172f51bc055a49a58e94.png"},8453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>i});var r=t(6540);const a={},o=r.createContext(a);function s(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);